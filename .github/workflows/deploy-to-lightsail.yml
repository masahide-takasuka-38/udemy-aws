name: Deploy to AWS Lightsail

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1
  LIGHTSAIL_SERVICE_NAME: streamlit-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: \${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: \${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: \${{ env.AWS_REGION }}

    - name: Build Docker image
      run: |
        echo "Building Docker image..."
        docker build -t streamlit-app:\${{ github.sha }} .
        echo "Docker image built successfully"

    - name: Push image to Lightsail
      run: |
        echo "Pushing image to Lightsail..."
        aws lightsail push-container-image \
          --service-name \${{ env.LIGHTSAIL_SERVICE_NAME }} \
          --label app \
          --image streamlit-app:\${{ github.sha }} \
          --region \${{ env.AWS_REGION }}
        echo "Image pushed successfully"

    - name: Deploy to Lightsail
      run: |
        echo "Creating deployment configuration..."
        
        # デプロイメント設定を作成
        cat > deployment.json << EOF
        {
          "app": {
            "image": ":\${{ env.LIGHTSAIL_SERVICE_NAME }}.app.\${{ github.run_number }}",
            "ports": {
              "8501": "HTTP"
            },
            "environment": {
              "STREAMLIT_SERVER_PORT": "8501",
              "STREAMLIT_SERVER_ADDRESS": "0.0.0.0"
            }
          }
        }
        EOF

        # パブリックエンドポイント設定
        cat > public-endpoint.json << EOF
        {
          "containerName": "app",
          "containerPort": 8501
        }
        EOF

        echo "Deploying to Lightsail..."
        aws lightsail create-container-service-deployment \
          --service-name \${{ env.LIGHTSAIL_SERVICE_NAME }} \
          --containers file://deployment.json \
          --public-endpoint file://public-endpoint.json \
          --region \${{ env.AWS_REGION }}
        
        echo "Deployment initiated successfully"

    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 90
        
        # サービス情報を取得
        SERVICE_INFO=\$(aws lightsail get-container-services \
          --service-name \${{ env.LIGHTSAIL_SERVICE_NAME }} \
          --region \${{ env.AWS_REGION }})
        
        SERVICE_URL=\$(echo "\$SERVICE_INFO" | jq -r '.containerServices[0].url // "Not available"')
        SERVICE_STATE=\$(echo "\$SERVICE_INFO" | jq -r '.containerServices[0].state // "Unknown"')
        
        echo "Service URL: \$SERVICE_URL"
        echo "Service State: \$SERVICE_STATE"
        
        if [ "\$SERVICE_STATE" = "RUNNING" ]; then
          echo "✅ Deployment completed successfully!"
        else
          echo "⚠️ Service state: \$SERVICE_STATE"
        fi
