name: Deploy to AWS Lightsail

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1
  LIGHTSAIL_SERVICE_NAME: streamlit-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: \${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: \${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: \${{ env.AWS_REGION }}

    - name: Build Docker image
      run: |
        docker build -t streamlit-app:\${{ github.sha }} .

    - name: Deploy to Lightsail
      run: |
        # 一時的なイメージファイルを作成
        docker save streamlit-app:\${{ github.sha }} > app-image.tar
        
        # Lightsailにイメージをアップロード
        aws lightsail push-container-image \
          --service-name \${{ env.LIGHTSAIL_SERVICE_NAME }} \
          --label app \
          --image streamlit-app:\${{ github.sha }}

        # デプロイメント設定を作成
        cat > deployment.json << EOF
        {
          "app": {
            "image": ":\${{ env.LIGHTSAIL_SERVICE_NAME }}.app.\${{ github.run_number }}",
            "ports": {
              "8501": "HTTP"
            },
            "environment": {
              "STREAMLIT_SERVER_PORT": "8501"
            }
          }
        }
        EOF

        # パブリックエンドポイント設定
        cat > public-endpoint.json << EOF
        {
          "containerName": "app",
          "containerPort": 8501
        }
        EOF

        # デプロイメント実行
        aws lightsail create-container-service-deployment \
          --service-name \${{ env.LIGHTSAIL_SERVICE_NAME }} \
          --containers file://deployment.json \
          --public-endpoint file://public-endpoint.json

    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 120
        
        # サービス情報を取得
        aws lightsail get-container-services \
          --service-name \${{ env.LIGHTSAIL_SERVICE_NAME }}
